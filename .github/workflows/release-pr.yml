name: Release PR

on:
    workflow_dispatch: {}

permissions:
    contents: write
    pull-requests: write
    issues: write

concurrency:
    group: release-pr
    cancel-in-progress: false

jobs:
    release-pr:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Conventional Changelog (no tag/release)
              id: changelog
              uses: TriPSs/conventional-changelog-action@v5
              with:
                  github-token: ${{ github.token }}
                  output-file: CHANGELOG.md
                  tag-prefix: v
                  skip-on-empty: true
                  version-file: custom_components/sungrow/manifest.json
                  version-path: version
                  preset: conventionalcommits
                  create-summary: true
                  skip-tag: true
                  skip-commit: true

            - name: Create release PR
              if: steps.changelog.outputs.skipped != 'true'
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ github.token }}
                  committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
                  author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
                  commit-message: "chore: release v${{ steps.changelog.outputs.version }}"
                  branch: "release/v${{ steps.changelog.outputs.version }}"
                  title: "chore: release v${{ steps.changelog.outputs.version }}"
                  body: |
                      ## Summary
                      - release version v${{ steps.changelog.outputs.version }}

                      ## Changelog
                      ${{ steps.changelog.outputs.clean_changelog }}

                  labels: |
                      release
                  add-paths: |
                      CHANGELOG.md
                      custom_components/mozillion/manifest.json

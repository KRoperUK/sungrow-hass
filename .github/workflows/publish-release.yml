name: Publish Release

on:
    pull_request:
        types:
            - closed
        branches:
            - main

permissions:
    contents: write

concurrency:
    group: publish-release
    cancel-in-progress: false

jobs:
    publish:
        if: |
            github.event.pull_request.merged == true &&
            contains(github.event.pull_request.labels.*.name, 'release')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Extract version from manifest
              id: version
              run: |
                  VERSION=$(grep '"version":' custom_components/sungrow/manifest.json | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Version extracted: ${VERSION}"

            - name: Create release tag and GitHub release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: Release v${{ steps.version.outputs.version }}
                  body_path: CHANGELOG.md
                  draft: false
                  prerelease: false
                  token: ${{ github.token }}

            - name: Remove dev tag
              run: |
                  git push origin :refs/tags/dev-v${{ steps.version.outputs.version }} 2>/dev/null || true
